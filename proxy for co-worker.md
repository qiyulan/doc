# proxy for co-worker

一直以来公司里都没有面向互联网的代理,大部分同事都没能使用到互联网.

终于有一天,一直在使用的功能并不怎么样的文档协同工具开始收费了,
于是终于忍受不了大陆局域网的特性了,决定在公司局域网内开放一个互联网代理.

## 方案选择

### 每人配置 vpn 或其他形式的代理

优点:
- 每个人可以选择个性化的工具来实现代理

缺点:
- 费用较高
- 配置麻烦,难以维护

此方法的优点可以说不存在,因为有能力自己选择代理的早就有自己的工具了,
而这次任务的目标就是那些没有代理的同事.

### SS 共享代理

优点:
- 宿主机支持多个平台

缺点:
- 所有流量都经过代理设备
- mac版本只提供 socks5 代理端口

SS 是一个优秀的代理协议,应该也是目前大陆最广泛使用的协议了.支持的客户端基本已经覆盖了全部的平台.
然而原版的 SS 局域网代理会让局域网所有流量从代理设备上通过,这似乎是难以接受的一个缺点.

### SSR 共享代理

优点:
- 支持 PAC 大陆流量无需经过代理设备
- 支持在默认规则配合自定义规则
- 支持 SSR 代理
- 支持多代理负载均衡
- 配置简单 图形化 支持多种方式导入

缺点:
- 不支持自动探测
- 宿主设备仅支持 win 平台

SSR 是目前 SS 最活跃的分支之一,其的局域网代理支持 PAC ,使得大陆流量无需经过代理设备,
多代理均衡做的很好而且有良好的图形化终端支持.然而其仅支持 windows 平台的宿主机.


### cow 代理

优点:
- 支持宿主设备丰富
- 支持预 PAC 已知的大陆流量无需经过代理设备
- 支持在默认规则配合自定义规则
- 支持自动探测网站能否联通
- 支持负载均衡,但模式单一

缺点:
- 程序配置复杂, ss 链接与其他客户端不兼容 需要手动填写

最终,我们选择了这个方案,因为其支持自动探测,可以探测访问的网站可否访问,即使该网站不在 GFW List 和 China ip List 上.
这个特性使得后续的维护非常简单,不用时常更新列表或者手动添加规则.
而且其是一个胶水客户端,可以配合其他代理工具一同使用.
至于程序配置复杂这一问题,对于已有多年代理经验的运维来说,并不是什么大问题.

## 开始配置

代理设备我们盯上了组内的集成测试服务器,因为其 7*24 小时不关机.

该服务器运行的是 OS X 系统, cow 的 listen address 配置为 0.0.0.0 即可监听所有 IP 地址,
这是考虑到了以后的外网访问,如果不想让外网访问到,请配置为 127.0.0.1 和 其在局域网内的 IP .

负载均衡策略使用了 hash ,因为局域网内用户较多,链接全部分配到同一个服务器上压力有点大.

不过值得注意的是 cow 在 win 平台的配置文件都带有 .txt 后缀,而其他平台均不带,最初没有注意到导致自定义规则失效了.

## 使用状况

配置完成后,在同事们的电脑上进行了简单的 PAC 代理设置,不需要其他设置,
浏览器和常见应用都可以正常访问互联网了.
在第一时间建立了 Google Groups,文档分享时也不用复制粘贴一大堆地址了,只需分想给这个群组即可.

##其他资源

[GFW List](https://github.com/gfwlist/gfwlist)

[China IP List](https://github.com/17mon/china_ip_list)

[GFW White List](https://github.com/breakwa11/gfw_whitelist)
